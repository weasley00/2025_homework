# Project4
## 一、SM3实现（代码中的sm3basic为基本实现，sm3plus为优化之后的）
| 特性 | 说明 |
|-------|-------|
| 输入 | 任意长度的比特消息 | 
| 输出 | 固定长度256比特（32字节） |
| 结构 | Merkle-Damgård结构 |
| 安全性 | 约128比特的抗碰撞安全性 |
| 应用 | 数字签名、消息认证码、密钥派生等 |
### 1、消息填充
为了使消息长度符合处理要求（长度为512比特的倍数）：在原始消息末尾添加比特'1'，添加k个比特'0'，k满足(l + 1 + k) ≡ 448 mod 512，添加64比特的无符号整数（大端序），值为原始消息比特长度l。
```python
def sm3_padding(message):
    l = len(message) * 8
    message += b'\x80'
    while (len(message)*8 + 64) % 512 != 0:
        message += b'\x00'
    message += l.to_bytes(8, 'big')
    return message
```
### 2、初始化杂凑值
使用固定的256比特初始值IV：


IV = 7380166F 4914B2B9 172442D7 DA8A0600 
     A96F30BC 163138AA E38DEE4D B0FB0E4E<br>
分为8个32比特字：
A = 7380166F
B = 4914B2B9
C = 172442D7
D = DA8A0600
E = A96F30BC
F = 163138AA
G = E38DEE4D
H = B0FB0E4E
### 3、迭代处理
填充后的消息分割成N个512比特分组：B⁽⁰⁾, B⁽¹⁾, ..., B⁽ᴺ⁻¹⁾
```c
V⁽⁰⁾ = IV;
for (i = 0; i < N; i++) {
    V⁽ⁱ⁺¹⁾ = CF(V⁽ⁱ⁾, B⁽ⁱ⁾);
}
H(m) = V⁽ᴺ⁾;
```
### 4、压缩函数CF(V, B)
#### 4.1 消息扩展
将512比特分组B划分为16个32比特字：W₀, W₁, ..., W₁₅<br>
扩展生成68个字（W₀到W₆₇）：

```c
for (j = 16; j < 68; j++) {
    Wⱼ = P₁(Wⱼ₋₁₆ ^ Wⱼ₋₉ ^ (Wⱼ₋₃ <<< 15)) ^ (Wⱼ₋₁₃ <<< 7) ^ Wⱼ₋₆;
}
```
其中P₁(X) = X ^ (X <<< 15) ^ (X <<< 23)。
计算64个字W'ⱼ：

```c
for (j = 0; j < 64; j++) {
    W'ⱼ = Wⱼ ^ Wⱼ₊₄;
}
```
#### 4.2 迭代压缩（64轮）
```c
// 初始化工作变量
(A, B, C, D, E, F, G, H) = V;

for (j = 0; j < 64; j++) {
    // 计算中间变量
    SS1 = ((A <<< 12) + E + (Tⱼ <<< j)) <<< 7;
    SS2 = SS1 ^ (A <<< 12);
    
    TT1 = FFⱼ(A, B, C) + D + SS2 + W'ⱼ;
    TT2 = GGⱼ(E, F, G) + H + SS1 + Wⱼ;
    
    // 更新工作变量
    D = C;
    C = B <<< 9;
    B = A;
    A = TT1;
    
    H = G;
    G = F <<< 19;
    F = E;
    E = P₀(TT2);
}
```
#### 4.3 函数和常量定义
布尔函数：

```c
// FF函数
if (0 <= j <= 15) 
    FFⱼ(X,Y,Z) = X ^ Y ^ Z;
else // j=16~63
    FFⱼ(X,Y,Z) = (X & Y) | (X & Z) | (Y & Z);

// GG函数
if (0 <= j <= 15) 
    GGⱼ(X,Y,Z) = X ^ Y ^ Z;
else // j=16~63
    GGⱼ(X,Y,Z) = (X & Y) | (~X & Z);
```
置换函数：

```c
P₀(X) = X ^ (X <<< 9) ^ (X <<< 17);
P₁(X) = X ^ (X <<< 15) ^ (X <<< 23);
```
常量Tⱼ：

```c
if (0 <= j <= 15)
    Tⱼ = 0x79CC4519;
else // j=16~63
    Tⱼ = 0x7A879D8A;
```
#### 4.4 与原始状态混合
```c
A' = A ^ A₀;
B' = B ^ B₀;
C' = C ^ C₀;
D' = D ^ D₀;
E' = E ^ E₀;
F' = F ^ F₀;
G' = G ^ G₀;
H' = H ^ H₀;
```







